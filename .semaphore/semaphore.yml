version: v1.0
name: test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: build
    task:
      env_vars:
        - name: DISCOURSE_HOSTNAME
          value: www.example.com
        - name: RUBY_GLOBAL_METHOD_CACHE_SIZE
          value: "131072"
        #BUILD_TYPE: ${{ matrix.build_types }}
        #TARGET: ${{ matrix.target }}
        - name: RAILS_ENV
          value: test
        - name: PGHOST
          value: localhost
        - name: PGUSER
          value: discourse
        - name: PGPASSWORD
          value: discourse
      prologue:
          commands:
            - checkout
            - git config --global user.email "ci@ci.invalid" && git config --global user.name "Discourse CI"
            - |-
                sudo apt-get -yqq install postgresql-client libpq-dev gifsicle jpegoptim optipng jhead && \
                wget -qO- https://raw.githubusercontent.com/discourse/discourse_docker/master/image/base/install-pngquant | sudo sh
            - |-
              if [ ${BUILD_TYPE} != "LINT" ]
              then
                sem-service start redis
              fi
            - sem-version ruby 2.6.3
            - gem install bundler -v 1.17.3 --no-doc
            - bundle install --without development --deployment --jobs 4 --retry 3 
            - yarn install --dev
            - |-
              if [ ${TARGET} == "PLUGINS" ]
              then
                bin/rake plugin:install_all_official
              fi
            - |-
              if [ ${BUILD_TYPE} != "LINT" ]
              then
                bin/rake db:create && bin/rake db:migrate
              fi
            - |-
              if [ ${BUILD_TYPE} == "BACKEND" && ${TARGET} == "CORE" ]
              then
                bin/rake parallel:create && bin/rake parallel:migrate
              fi
      jobs:
        - name: Rubocop
          commands:
            - |-
              if [ ${BUILD_TYPE} == "LINT" ]
              then
                bundle exec rubocop .
              fi        

          matrix:
            - env_var: build_types
              values: [ "BACKEND", "FRONTEND", "LINT" ]
            - env_var: target
              values: [ "PLUGINS", "CORE" ]    