version: v1.0
name: Ruby
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: build
    task:
      jobs:
        - name: build&test
          commands:
            - checkout
            - sem-version ruby 2.6.3
            - >-
              wget -qO-
              https://raw.githubusercontent.com/discourse/discourse_docker/master/image/base/install-pngquant
              | sudo sh
            - nvm install node
            - npm install -g svgo
            - node --version
            - gem install bundler -v 1.17.3
            - sudo apt-get update -y && sudo apt-get install -y gifsicle jpegoptim optipng jhead redis-server postgresql postgresql-client libpq-dev
            - sudo -u postgres createuser -s "${USER}"
            - git clone --depth=1 https://github.com/discourse/discourse-backup-uploads-to-s3.git plugins/discourse-backup-uploads-to-s3
            - git clone --depth=1 https://github.com/discourse/discourse-spoiler-alert.git plugins/discourse-spoiler-alert
            - git clone --depth=1 https://github.com/discourse/discourse-cakeday.git plugins/discourse-cakeday
            - git clone --depth=1 https://github.com/discourse/discourse-canned-replies.git plugins/discourse-canned-replies
            - git clone --depth=1 https://github.com/discourse/discourse-chat-integration.git plugins/discourse-chat-integration
            - git clone --depth=1 https://github.com/discourse/discourse-assign.git plugins/discourse-assign
            - git clone --depth=1 https://github.com/discourse/discourse-patreon.git plugins/discourse-patreon
            - git clone --depth=1 https://github.com/discourse/discourse-user-notes.git plugins/discourse-user-notes
            - git clone --depth=1 https://github.com/discourse/discourse-group-tracker
            - >-
              bash -c "if [ '${RAILS_MASTER}' == '1' ]; then bundle update --retry=3
              --jobs=3 arel rails seed-fu; fi"
            - >-
              bash -c "if [ '${RAILS_MASTER}' == '0' ]; then bundle install
              --without development --deployment --retry=3 --jobs=3; fi"
            - >-
              bash -c "if [ '${QUNIT_RUN}' == '1' ] || [ '${RUN_LINT}' == '1' ]; then
              yarn install --dev; fi"
            - >-
              bash -c "if [ '${RUN_LINT}' != '1' ]; then bundle exec rake db:create
              && LOAD_PLUGINS=1 bundle exec rake db:migrate; fi"
            - >-
              bash -c "
                    if [ '${RUN_LINT}' == '1' ]; then
                      npx lefthook run lints
                    else
                      if [ '${QUNIT_RUN}' == '1' ]; then
                        bundle exec rake qunit:test['1200000'] && \
                        bundle exec rake qunit:test['1200000','/wizard/qunit'] && \
                        bundle exec rake plugin:qunit
                      else
                        bundle exec rspec && bundle exec rake plugin:spec
                      fi
                    fi
                  "
          matrix:
            - env_var: RAILS_MASTER
              values: ["0"]
            - env_var: QUNIT_RUN
              values: ["0", "1"]
            - env_var: RUN_LINT
              values: ["0", "1"]
      env_vars:
        - name: DISCOURSE_HOSTNAME
          value: www.example.com
        - name: RUBY_GLOBAL_METHOD_CACHE_SIZE
          value: '131072'
    skip:
      when: branch != 'master' AND branch != 'beta' AND branch != 'stable'
